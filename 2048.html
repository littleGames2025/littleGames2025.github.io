<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼˜åŒ–ç‰ˆ2048 | ä¿®å¤æ»‘åŠ¨åˆå¹¶é—®é¢˜</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-family: 'Segoe UI', Tahoma, sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            padding: 10px;
            overflow: hidden;
        }

        .game-container {
            width: 95%;
            max-width: 550px;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .title {
            font-size: 2.5rem;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
            letter-spacing: 1px;
        }

        .scores-container {
            display: flex;
            gap: 12px;
        }

        .score-box {
            background: rgba(0, 0, 0, 0.2);
            padding: 12px 16px;
            border-radius: 12px;
            text-align: center;
            min-width: 100px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .score-title {
            font-size: 1rem;
            margin-bottom: 5px;
            opacity: 0.9;
        }

        .score-value {
            font-size: 2rem;
            font-weight: bold;
            letter-spacing: 1px;
        }

        .game-intro {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .restart-button {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 12px 25px;
            font-size: 1.1rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .restart-button:hover {
            transform: scale(1.05);
            background: #ff5252;
        }

        .game-explanation {
            font-size: 1rem;
            opacity: 0.85;
            max-width: 60%;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        .grid-container {
            position: relative;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 12px;
            padding: 15px;
            margin: 0 auto;
            touch-action: none;
            width: 100%;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            grid-template-rows: repeat(4, 1fr);
            gap: 15px;
            width: 100%;
            aspect-ratio: 1/1;
        }

        .grid-cell {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            box-shadow: inset 0 0 10px rgba(255, 255, 255, 0.1);
        }

        .tile {
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-weight: bold;
            border-radius: 10px;
            transition: transform 0.15s ease, opacity 0.15s ease;
            z-index: 10;
            font-size: 1.8rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
            will-change: transform;
        }

        .tile-new {
            animation: appear 0.2s;
        }

        .tile-merged {
            animation: pop 0.2s;
        }

        .game-message {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            border-radius: 12px;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 100;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(3px);
        }

        .game-message p {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 25px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .game-message button {
            background: #ff6b6b;
            color: white;
            border: none;
            border-radius: 10px;
            padding: 15px 35px;
            font-size: 1.3rem;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s;
        }

        .game-message button:hover {
            transform: scale(1.05);
            background: #ff5252;
        }

        .swipe-instruction {
            text-align: center;
            margin-top: 15px;
            font-size: 1.1rem;
            opacity: 0.85;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
        }

        @keyframes appear {
            0% { transform: scale(0); opacity: 0; }
            100% { transform: scale(1); opacity: 1; }
        }

        @keyframes pop {
            0% { transform: scale(0.8); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 500px) {
            .game-container {
                padding: 15px;
                width: 100%;
            }
            
            .title {
                font-size: 2.2rem;
            }
            
            .score-box {
                padding: 10px 14px;
                min-width: 90px;
            }
            
            .score-value {
                font-size: 1.8rem;
            }
            
            .restart-button {
                padding: 10px 20px;
                font-size: 1rem;
            }
            
            .grid {
                gap: 12px;
            }
            
            .grid-container {
                padding: 12px;
            }
            
            .grid-cell {
                border-radius: 8px;
            }
        }

        @media (max-width: 400px) {
            .title {
                font-size: 2rem;
            }
            
            .score-box {
                padding: 8px 12px;
                min-width: 80px;
            }
            
            .score-value {
                font-size: 1.6rem;
            }
            
            .game-explanation {
                font-size: 0.9rem;
            }
            
            .grid {
                gap: 10px;
            }
            
            .grid-container {
                padding: 10px;
            }
            
            .tile {
                font-size: 1.6rem;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="header">
            <div class="title">2048</div>
            <div class="scores-container">
                <div class="score-box">
                    <div class="score-title">åˆ†æ•°</div>
                    <div class="score-value" id="score">0</div>
                </div>
                <div class="score-box">
                    <div class="score-title">æœ€ä½³</div>
                    <div class="score-value" id="best-score">0</div>
                </div>
            </div>
        </div>
        
        <div class="game-intro">
            <div class="game-explanation">
                <b>æ¸¸æˆè§„åˆ™ï¼š</b> æ»‘åŠ¨æ–¹å—ï¼Œç›¸åŒæ•°å­—åˆå¹¶ï¼ŒåŠªåŠ›å¾—åˆ°2048æ–¹å—ï¼
            </div>
            <button class="restart-button" id="restart-button">æ–°æ¸¸æˆ</button>
        </div>
        
        <div class="grid-container">
            <div class="grid" id="grid"></div>
            <div class="game-message" id="game-message">
                <p></p>
                <button class="retry-button">å†è¯•ä¸€æ¬¡</button>
            </div>
        </div>
        
        <div class="swipe-instruction">
            åœ¨æ‰‹æœºä¸Šæ»‘åŠ¨å±å¹•æ§åˆ¶æ–¹å—ç§»åŠ¨
        </div>
    </div>

    <script>
        // æ¸¸æˆçŠ¶æ€ç®¡ç†
        const gameState = {
            grid: Array(4).fill().map(() => Array(4).fill(0)),
            tiles: {}, // è·Ÿè¸ªæ‰€æœ‰æ–¹å—å¯¹è±¡
            score: 0,
            bestScore: 0,
            gameOver: false,
            won: false,
            moveInProgress: false // é˜²æ­¢æ»‘åŠ¨ä¸­çš„å¹¶å‘æ“ä½œ
        };

        // DOMå…ƒç´ å¼•ç”¨
        const elements = {
            grid: document.getElementById('grid'),
            score: document.getElementById('score'),
            bestScore: document.getElementById('best-score'),
            gameMessage: document.getElementById('game-message'),
            restartButton: document.getElementById('restart-button')
        };

        // æ–¹å—é¢œè‰²é…ç½®
        const tileColors = {
            2: { background: '#EEE4DA', color: '#786F65' },
            4: { background: '#EDE0C8', color: '#786F65' },
            8: { background: '#F2B179', color: '#F9F6F2' },
            16: { background: '#F59563', color: '#F9F6F2' },
            32: { background: '#F67C5F', color: '#F9F6F2' },
            64: { background: '#F65E3B', color: '#F9F6F2' },
            128: { background: '#EDCF72', color: '#F9F6F2', fontSize: '2.5rem' },
            256: { background: '#EDCC61', color: '#F9F6F2', fontSize: '2.5rem' },
            512: { background: '#EDC850', color: '#F9F6F2', fontSize: '2.5rem' },
            1024: { background: '#EDC53F', color: '#F9F6F2', fontSize: '2rem' },
            2048: { background: '#EDC22E', color: '#F9F6F2', fontSize: '2rem' },
            4096: { background: '#3D3A33', color: '#F9F6F2', fontSize: '1.8rem' },
            8192: { background: '#202020', color: '#F9F6F2', fontSize: '1.8rem' }
        };

        // æ¸¸æˆåˆå§‹åŒ–
        function initGame() {
            createGrid();
            resetGame();
            addRandomTile();
            addRandomTile();
            updateUI();
            setupEventListeners();
        }

        // åˆ›å»ºç½‘æ ¼
        function createGrid() {
            elements.grid.innerHTML = '';
            for (let i = 0; i < 16; i++) {
                const cell = document.createElement('div');
                cell.className = 'grid-cell';
                elements.grid.appendChild(cell);
            }
        }

        // é‡ç½®æ¸¸æˆ
        function resetGame() {
            gameState.score = 0;
            gameState.gameOver = false;
            gameState.won = false;
            gameState.grid = Array(4).fill().map(() => Array(4).fill(0));
            gameState.tiles = {};
            
            // éšè—æ¸¸æˆæ¶ˆæ¯
            elements.gameMessage.style.display = 'none';
            
            // ç§»é™¤æ‰€æœ‰æ–¹å—
            document.querySelectorAll('.tile').forEach(tile => tile.remove());
        }

        // æ·»åŠ éšæœºæ–¹å—
        function addRandomTile() {
            const emptyCells = [];
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    if (gameState.grid[i][j] === 0) {
                        emptyCells.push({ row: i, col: j });
                    }
                }
            }
            
            if (emptyCells.length > 0) {
                const randomCell = emptyCells[Math.floor(Math.random() * emptyCells.length)];
                const value = Math.random() < 0.9 ? 2 : 4;
                
                // æ›´æ–°æ¸¸æˆçŠ¶æ€
                gameState.grid[randomCell.row][randomCell.col] = value;
                
                // åˆ›å»ºæ–¹å—å…ƒç´ 
                createTile(randomCell.row, randomCell.col, value, true);
            }
        }

        // åˆ›å»ºæ–¹å—
        function createTile(row, col, value, isNew = false) {
            const tileKey = `${row}_${col}`;
            
            // å¦‚æœè¯¥ä½ç½®å·²æœ‰æ–¹å—ï¼Œåˆ™ç§»é™¤å®ƒ
            if (gameState.tiles[tileKey]) {
                gameState.tiles[tileKey].element.remove();
            }
            
            const tile = document.createElement('div');
            tile.className = 'tile';
            tile.dataset.row = row;
            tile.dataset.col = col;
            
            if (isNew) tile.classList.add('tile-new');
            
            // è®¾ç½®æ–¹å—æ ·å¼
            tile.textContent = value;
            
            // åº”ç”¨é¢œè‰²å’Œå­—ä½“å¤§å°
            const colorConfig = tileColors[value] || tileColors['8192'];
            tile.style.background = colorConfig.background;
            tile.style.color = colorConfig.color;
            tile.style.fontSize = colorConfig.fontSize || '1.8rem';
            
            // è®¾ç½®ä½ç½®
            updateTilePosition(tile);
            
            // æ·»åŠ åˆ°ç½‘æ ¼å®¹å™¨
            document.querySelector('.grid-container').appendChild(tile);
            
            // ä¿å­˜æ–¹å—ä¿¡æ¯
            gameState.tiles[tileKey] = {
                element: tile,
                row: row,
                col: col,
                value: value,
                merged: false
            };
            
            return tile;
        }

        // æ›´æ–°æ–¹å—ä½ç½®
        function updateTilePosition(tile) {
            const row = parseInt(tile.dataset.row);
            const col = parseInt(tile.dataset.col);
            const grid = document.querySelector('.grid');
            const gridRect = grid.getBoundingClientRect();
            
            // è®¡ç®—å•å…ƒæ ¼å°ºå¯¸
            const cellWidth = gridRect.width / 4;
            const cellHeight = gridRect.height / 4;
            const padding = 5;
            
            // è®¡ç®—å½“å‰ä½ç½®
            const left = col * cellWidth + padding;
            const top = row * cellHeight + padding;
            
            // è®¾ç½®æ–¹å—å¤§å°
            const size = Math.min(cellWidth, cellHeight) - 2 * padding;
            tile.style.width = `${size}px`;
            tile.style.height = `${size}px`;
            
            // è®¾ç½®ä½ç½®
            tile.style.left = `${left}px`;
            tile.style.top = `${top}px`;
        }

        // ç§»åŠ¨æ–¹å—
        function move(direction) {
            if (gameState.moveInProgress || gameState.gameOver) return;
            gameState.moveInProgress = true;
            
            // é‡ç½®æ‰€æœ‰æ–¹å—çš„åˆå¹¶çŠ¶æ€
            resetTileMergedStatus();
            
            let moved = false;
            let gridChanged = false;
            
            switch (direction) {
                case 'up': 
                    moved = moveUp();
                    break;
                case 'down': 
                    moved = moveDown();
                    break;
                case 'left': 
                    moved = moveLeft();
                    break;
                case 'right': 
                    moved = moveRight();
                    break;
            }
            
            if (moved) {
                // æ·»åŠ æ–°æ–¹å—
                addRandomTile();
                
                // æ›´æ–°UI
                updateUI();
                
                // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
                checkGameStatus();
            }
            
            gameState.moveInProgress = false;
        }

        // é‡ç½®æ‰€æœ‰æ–¹å—çš„åˆå¹¶çŠ¶æ€
        function resetTileMergedStatus() {
            for (const key in gameState.tiles) {
                gameState.tiles[key].merged = false;
            }
        }

        // å‘ä¸Šç§»åŠ¨
        function moveUp() {
            let moved = false;
            
            // ä»ç¬¬äºŒè¡Œå¼€å§‹å‘ä¸‹å¤„ç†ï¼Œè®©æ–¹å—å¾€ä¸Šç§»åŠ¨
            for (let row = 1; row < 4; row++) {
                for (let col = 0; col < 4; col++) {
                    const currentValue = gameState.grid[row][col];
                    if (currentValue === 0) continue;
                    
                    let newRow = row;
                    while (newRow > 0) {
                        const aboveRow = newRow - 1;
                        const aboveValue = gameState.grid[aboveRow][col];
                        
                        if (aboveValue === 0) {
                            // ç§»åŠ¨åˆ°ç©ºä½ç½®
                            moveTile(row, col, aboveRow, col);
                            moved = true;
                            newRow = aboveRow;
                        } 
                        else if (aboveValue === currentValue && !isTileMerged(aboveRow, col)) {
                            // åˆå¹¶ç›¸åŒæ–¹å—
                            mergeTiles(row, col, aboveRow, col);
                            moved = true;
                            break;
                        } 
                        else {
                            // é‡åˆ°ä¸åŒæ•°å­—æˆ–å·²åˆå¹¶çš„æ–¹å—ï¼Œåœæ­¢ç§»åŠ¨
                            break;
                        }
                    }
                }
            }
            
            return moved;
        }

        // å‘ä¸‹ç§»åŠ¨
        function moveDown() {
            let moved = false;
            
            // ä»ä¸‹å¾€ä¸Šå¤„ç†
            for (let row = 2; row >= 0; row--) {
                for (let col = 0; col < 4; col++) {
                    const currentValue = gameState.grid[row][col];
                    if (currentValue === 0) continue;
                    
                    let newRow = row;
                    while (newRow < 3) {
                        const belowRow = newRow + 1;
                        const belowValue = gameState.grid[belowRow][col];
                        
                        if (belowValue === 0) {
                            // ç§»åŠ¨åˆ°ç©ºä½ç½®
                            moveTile(row, col, belowRow, col);
                            moved = true;
                            newRow = belowRow;
                        } 
                        else if (belowValue === currentValue && !isTileMerged(belowRow, col)) {
                            // åˆå¹¶ç›¸åŒæ–¹å—
                            mergeTiles(row, col, belowRow, col);
                            moved = true;
                            break;
                        } 
                        else {
                            // é‡åˆ°ä¸åŒæ•°å­—æˆ–å·²åˆå¹¶çš„æ–¹å—ï¼Œåœæ­¢ç§»åŠ¨
                            break;
                        }
                    }
                }
            }
            
            return moved;
        }

        // å‘å·¦ç§»åŠ¨
        function moveLeft() {
            let moved = false;
            
            for (let row = 0; row < 4; row++) {
                for (let col = 1; col < 4; col++) {
                    const currentValue = gameState.grid[row][col];
                    if (currentValue === 0) continue;
                    
                    let newCol = col;
                    while (newCol > 0) {
                        const leftCol = newCol - 1;
                        const leftValue = gameState.grid[row][leftCol];
                        
                        if (leftValue === 0) {
                            // ç§»åŠ¨åˆ°ç©ºä½ç½®
                            moveTile(row, col, row, leftCol);
                            moved = true;
                            newCol = leftCol;
                        } 
                        else if (leftValue === currentValue && !isTileMerged(row, leftCol)) {
                            // åˆå¹¶ç›¸åŒæ–¹å—
                            mergeTiles(row, col, row, leftCol);
                            moved = true;
                            break;
                        } 
                        else {
                            // é‡åˆ°ä¸åŒæ•°å­—æˆ–å·²åˆå¹¶çš„æ–¹å—ï¼Œåœæ­¢ç§»åŠ¨
                            break;
                        }
                    }
                }
            }
            
            return moved;
        }

        // å‘å³ç§»åŠ¨
        function moveRight() {
            let moved = false;
            
            for (let row = 0; row < 4; row++) {
                for (let col = 2; col >= 0; col--) {
                    const currentValue = gameState.grid[row][col];
                    if (currentValue === 0) continue;
                    
                    let newCol = col;
                    while (newCol < 3) {
                        const rightCol = newCol + 1;
                        const rightValue = gameState.grid[row][rightCol];
                        
                        if (rightValue === 0) {
                            // ç§»åŠ¨åˆ°ç©ºä½ç½®
                            moveTile(row, col, row, rightCol);
                            moved = true;
                            newCol = rightCol;
                        } 
                        else if (rightValue === currentValue && !isTileMerged(row, rightCol)) {
                            // åˆå¹¶ç›¸åŒæ–¹å—
                            mergeTiles(row, col, row, rightCol);
                            moved = true;
                            break;
                        } 
                        else {
                            // é‡åˆ°ä¸åŒæ•°å­—æˆ–å·²åˆå¹¶çš„æ–¹å—ï¼Œåœæ­¢ç§»åŠ¨
                            break;
                        }
                    }
                }
            }
            
            return moved;
        }

        // æ£€æŸ¥æ–¹å—æ˜¯å¦å·²åˆå¹¶
        function isTileMerged(row, col) {
            const tileKey = `${row}_${col}`;
            return gameState.tiles[tileKey] && gameState.tiles[tileKey].merged;
        }

        // ç§»åŠ¨æ–¹å—åˆ°æ–°ä½ç½®
        function moveTile(fromRow, fromCol, toRow, toCol) {
            // æ›´æ–°ç½‘æ ¼çŠ¶æ€
            gameState.grid[toRow][toCol] = gameState.grid[fromRow][fromCol];
            gameState.grid[fromRow][fromCol] = 0;
            
            // æ›´æ–°æ–¹å—çŠ¶æ€
            const fromKey = `${fromRow}_${fromCol}`;
            if (gameState.tiles[fromKey]) {
                gameState.tiles[fromKey].row = toRow;
                gameState.tiles[fromKey].col = toCol;
                
                const toKey = `${toRow}_${toCol}`;
                gameState.tiles[toKey] = gameState.tiles[fromKey];
                delete gameState.tiles[fromKey];
                
                // æ›´æ–°DOMå±æ€§
                const tileElement = gameState.tiles[toKey].element;
                tileElement.dataset.row = toRow;
                tileElement.dataset.col = toCol;
                updateTilePosition(tileElement);
            }
        }

        // åˆå¹¶æ–¹å—
        function mergeTiles(fromRow, fromCol, toRow, toCol) {
            const fromValue = gameState.grid[fromRow][fromCol];
            const toValue = gameState.grid[toRow][toCol];
            
            if (fromValue === toValue) {
                // æ›´æ–°ç›®æ ‡ä½ç½®çš„æ•°å€¼
                const newValue = fromValue * 2;
                gameState.grid[toRow][toCol] = newValue;
                
                // æ·»åŠ åˆ†æ•°
                gameState.score += newValue;
                
                // ç§»é™¤æ¥æºä½ç½®çš„æ–¹å—
                gameState.grid[fromRow][fromCol] = 0;
                const fromKey = `${fromRow}_${fromCol}`;
                if (gameState.tiles[fromKey]) {
                    gameState.tiles[fromKey].element.remove();
                    delete gameState.tiles[fromKey];
                }
                
                // æ›´æ–°ç›®æ ‡ä½ç½®çš„æ–¹å—çŠ¶æ€
                const toKey = `${toRow}_${toCol}`;
                if (gameState.tiles[toKey]) {
                    // æ ‡è®°è¯¥æ–¹å—å·²ç»åˆå¹¶
                    gameState.tiles[toKey].merged = true;
                    
                    // æ›´æ–°DOM
                    gameState.tiles[toKey].value = newValue;
                    const tileElement = gameState.tiles[toKey].element;
                    tileElement.textContent = newValue;
                    
                    // æ›´æ–°æ ·å¼
                    const colorConfig = tileColors[newValue] || tileColors['8192'];
                    tileElement.style.background = colorConfig.background;
                    tileElement.style.color = colorConfig.color;
                    
                    // æ·»åŠ åˆå¹¶åŠ¨ç”»
                    tileElement.classList.add('tile-merged');
                    setTimeout(() => tileElement.classList.remove('tile-merged'), 200);
                }
            }
        }

        // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
        function checkGameStatus() {
            // æ£€æŸ¥æ˜¯å¦è·èƒœ
            if (!gameState.won) {
                for (let i = 0; i < 4; i++) {
                    for (let j = 0; j < 4; j++) {
                        if (gameState.grid[i][j] === 2048) {
                            gameState.won = true;
                            showGameMessage("ä½ èµ¢äº†! ğŸ‰", false);
                            return;
                        }
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦å¤±è´¥
            if (!hasMoves()) {
                gameState.gameOver = true;
                showGameMessage("æ¸¸æˆç»“æŸ! ğŸ˜¢", true);
            }
        }

        // æ£€æŸ¥æ˜¯å¦æœ‰å¯ç§»åŠ¨çš„æ–¹å—
        function hasMoves() {
            // æ£€æŸ¥æ˜¯å¦æœ‰ç©ºæ ¼
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    if (gameState.grid[i][j] === 0) {
                        return true;
                    }
                }
            }
            
            // æ£€æŸ¥æ˜¯å¦æœ‰å¯åˆå¹¶çš„ç›¸é‚»æ–¹å—
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 4; j++) {
                    const value = gameState.grid[i][j];
                    
                    // æ£€æŸ¥å³ä¾§
                    if (j < 3 && gameState.grid[i][j+1] === value) {
                        return true;
                    }
                    
                    // æ£€æŸ¥ä¸‹æ–¹
                    if (i < 3 && gameState.grid[i+1][j] === value) {
                        return true;
                    }
                }
            }
            
            return false;
        }

        // æ˜¾ç¤ºæ¸¸æˆæ¶ˆæ¯
        function showGameMessage(message, isGameOver) {
            elements.gameMessage.style.display = 'flex';
            elements.gameMessage.querySelector('p').textContent = message;
            
            if (isGameOver) {
                elements.gameMessage.querySelector('button').textContent = 'å†è¯•ä¸€æ¬¡';
            } else {
                elements.gameMessage.querySelector('button').textContent = 'ç»§ç»­æ¸¸æˆ';
            }
        }

        // æ›´æ–°UI
        function updateUI() {
            // æ›´æ–°åˆ†æ•°
            elements.score.textContent = gameState.score;
            
            // æ›´æ–°æœ€ä½³åˆ†æ•°
            if (gameState.score > gameState.bestScore) {
                gameState.bestScore = gameState.score;
                elements.bestScore.textContent = gameState.bestScore;
                localStorage.setItem('2048_best_score', gameState.bestScore);
            }
            
            // æ›´æ–°æ‰€æœ‰æ–¹å—ä½ç½®
            for (const key in gameState.tiles) {
                updateTilePosition(gameState.tiles[key].element);
            }
        }

        // è®¾ç½®äº‹ä»¶ç›‘å¬
        function setupEventListeners() {
            // é”®ç›˜æ§åˆ¶
            document.addEventListener('keydown', (e) => {
                if (gameState.gameOver) return;
                
                switch (e.key) {
                    case 'ArrowUp': move('up'); break;
                    case 'ArrowDown': move('down'); break;
                    case 'ArrowLeft': move('left'); break;
                    case 'ArrowRight': move('right'); break;
                }
            });
            
            // è§¦æ‘¸æ§åˆ¶
            let touchStartX = 0;
            let touchStartY = 0;
            let lastMoveTime = 0;
            
            const gridContainer = document.querySelector('.grid-container');
            
            gridContainer.addEventListener('touchstart', (e) => {
                if (gameState.gameOver) return;
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
                e.preventDefault();
            }, { passive: false });
            
            gridContainer.addEventListener('touchend', (e) => {
                if (gameState.gameOver || !touchStartX || !touchStartY) return;
                
                // ç®€å•èŠ‚æµæ§åˆ¶
                const now = Date.now();
                if (now - lastMoveTime < 200) return;
                lastMoveTime = now;
                
                const touchEndX = e.changedTouches[0].clientX;
                const touchEndY = e.changedTouches[0].clientY;
                
                const dx = touchEndX - touchStartX;
                const dy = touchEndY - touchStartY;
                const absDx = Math.abs(dx);
                const absDy = Math.abs(dy);
                
                // ç¡®å®šæ»‘åŠ¨æ–¹å‘ï¼ˆéœ€è¦æ˜æ˜¾æ»‘åŠ¨æ‰è§¦å‘ï¼‰
                if (Math.max(absDx, absDy) > 30) {
                    if (absDx > absDy) {
                        // æ°´å¹³æ»‘åŠ¨
                        if (dx > 0) move('right');
                        else move('left');
                    } else {
                        // å‚ç›´æ»‘åŠ¨
                        if (dy > 0) move('down');
                        else move('up');
                    }
                }
                
                touchStartX = 0;
                touchStartY = 0;
            });
            
            // é‡æ–°å¼€å§‹æŒ‰é’®
            elements.restartButton.addEventListener('click', () => {
                resetGame();
                addRandomTile();
                addRandomTile();
                updateUI();
            });
            
            // æ¸¸æˆæ¶ˆæ¯æŒ‰é’®
            elements.gameMessage.querySelector('button').addEventListener('click', () => {
                if (gameState.gameOver) {
                    resetGame();
                    addRandomTile();
                    addRandomTile();
                } else {
                    elements.gameMessage.style.display = 'none';
                }
                updateUI();
            });
        }

        // åˆå§‹åŒ–æ¸¸æˆ
        window.addEventListener('load', () => {
            // ä»æœ¬åœ°å­˜å‚¨åŠ è½½æœ€ä½³åˆ†æ•°
            gameState.bestScore = parseInt(localStorage.getItem('2048_best_score')) || 0;
            elements.bestScore.textContent = gameState.bestScore;
            
            // åˆå§‹åŒ–æ¸¸æˆ
            initGame();
        });

        // çª—å£å¤§å°å˜åŒ–æ—¶æ›´æ–°æ–¹å—ä½ç½®
        window.addEventListener('resize', () => {
            for (const key in gameState.tiles) {
                updateTilePosition(gameState.tiles[key].element);
            }
        });
    </script>
</body>
</html>
